name: Trading Deploy
run-name: ${{ github.actor }} is deploying a quant trading algorithm.

on:
  schedule: ## Opening times US market: 13:30-20:00 UTC
    - cron:  '30 13 * * 1-5' ## Minute, hour (UTC), day, month, day of the week (0-6)(Sunday to Saturday)
  workflow_dispatch:        # Allows manual trigger

# Allow pushing back to the repo
permissions:
  contents: write

jobs:
  trade:
    runs-on: ubuntu-latest
    env:
      API_KEY: ${{ secrets.API_KEY }}
      API_SECRET: ${{ secrets.API_SECRET }}
      PAPER: True

    steps:
      - name: Checkout repo (shallow)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 1

      - name: Free disk space (remove unused SDKs)
        run: |
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet      || true
          sudo rm -rf /opt/ghc               || true
          sudo rm -rf /usr/local/.ghcup      || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies (no pip cache)
        run: |
          python -m pip install -U pip
          pip install --no-cache-dir --prefer-binary -r requirements.txt
          pip cache purge || true
          df -h

      - name: Deploy strategy
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: python main/deploy.py

      # - name: Commit & push changes
      #   run: |
      #     git config user.name  "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"
      #     git add trades_info.json live_trading_report.md
      #     if ! git diff --cached --quiet; then
      #       git commit -m "Auto-update trades_info.json"
      #       git push
      #     else
      #       echo "No changes to commit."
      #     fi

      - name: Send report as email body
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port:    ${{ secrets.SMTP_PORT }}
          username:       ${{ secrets.SMTP_USERNAME }}
          password:       ${{ secrets.SMTP_PASSWORD }}
          subject:        "Daily Live Trading Report"
          from:           ${{ secrets.SMTP_USERNAME }}
          to:             ${{ secrets.SMTP_USERNAME }}
          content_type:   text/plain
          body:           file://live_trading_report.md