name: Rebalance Portfolio Deploy
run-name: ${{ github.actor }} is rebalancing the portfolio. 

on:
  schedule: ##Opening times US market: 13:30-20:00 UTC
    - cron:  '30 13 9 * *' ##Minute, hour (UTC), day, month, day of the week (0-6)(Sunday to Saturday)
  workflow_dispatch:        # Allows manual trigger

# Allow pushing back to the repo
permissions:
  contents: write

jobs:
  trade:
    runs-on: ubuntu-latest
    env:
      API_KEY: ${{ secrets.API_KEY }}
      API_SECRET: ${{ secrets.API_SECRET }}
      PAPER: True

    steps:
      - name: Checkout repo (shallow)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 1

      # Optional but very helpful on space-constrained jobs. Remove only what you don't use.
      - name: Free disk space (remove unused SDKs)
        run: |
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet      || true
          sudo rm -rf /opt/ghc               || true
          sudo rm -rf /usr/local/.ghcup      || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # Use a version with widespread manylinux/macos wheels to avoid building from source
          python-version: '3.11'

      - name: Install dependencies (no pip cache)
        run: |
          python -m pip install -U pip
          # Prefer wheels to avoid bulky source builds (doesn't hard-fail if a wheel isn't available)
          pip install --no-cache-dir --prefer-binary -r requirements.txt
          # Belt & suspenders: ensure any residual caches are cleared
          pip cache purge || true
          df -h

      - name: Deploy portfolio rebalance
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: python main/rebalance_portfolio.py

      # - name: Commit & push changes
      #   run: |
      #     git config user.name  "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"
      #     git add live_portfolio_rebalance.md
      #     if ! git diff --cached --quiet; then
      #       git commit -m "Auto-update live_portfolio_rebalance"
      #       git push
      #     else
      #       echo "No changes to commit."
      #     fi

      - name: Send report as email body
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port:    ${{ secrets.SMTP_PORT }}
          username:       ${{ secrets.SMTP_USERNAME }}
          password:       ${{ secrets.SMTP_PASSWORD }}
          subject:        "Monthly Portfolio Rebalance Report"
          from:           ${{ secrets.SMTP_USERNAME }}
          to:             ${{ secrets.SMTP_USERNAME }}
          content_type:   text/plain
          body:           file://live_portfolio_rebalance.md